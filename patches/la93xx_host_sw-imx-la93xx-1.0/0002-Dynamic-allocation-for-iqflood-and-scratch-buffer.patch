From 3500f17007c391c7df18dbe73e244be963339588 Mon Sep 17 00:00:00 2001
From: Francois Massot-Pellet <francois.massot-pellet@nxp.com>
Date: Mon, 26 Jan 2026 16:15:27 +0100
Subject: [PATCH] Dynamicr allocation for iqflood and scratch buffer

Signed-off-by: Francois Massot-Pellet <francois.massot-pellet@nxp.com>
---
 kernel_driver/la9310shiva/la9310_base.c    | 255 +++++++++++++--------
 kernel_driver/la9310shiva/la9310_base.h    |   6 +-
 kernel_driver/la9310shiva/la9310_modinfo.c |   4 +-
 kernel_driver/la9310shiva/la9310_pci.c     |  27 +--
 4 files changed, 169 insertions(+), 123 deletions(-)

diff --git a/kernel_driver/la9310shiva/la9310_base.c b/kernel_driver/la9310shiva/la9310_base.c
index 7edce09..812cd43 100644
--- a/kernel_driver/la9310shiva/la9310_base.c
+++ b/kernel_driver/la9310shiva/la9310_base.c
@@ -396,6 +396,62 @@ la9310_init_subdrv_dma_buf(struct la9310_dev *la9310_dev)
 	}
 }
 
+static int la9310_alloc_dma_buf(struct device* dev,
+    const char* buf_name,
+    struct la9310_mem_region_info* buf_info,
+    int buf_size,
+    enum dma_data_direction dma_dir)
+{
+    int status;
+
+    buf_info->vaddr = kzalloc(buf_size, GFP_KERNEL);
+    if (!buf_info->vaddr)
+    {
+        dev_err(dev, "Failed to allocate %s\n", buf_name);
+        return -ENOMEM;
+    }
+
+    buf_info->size = buf_size;
+
+    buf_info->phys_addr = dma_map_single(dev, buf_info->vaddr, buf_size, dma_dir);
+    status = dma_mapping_error(dev, buf_info->phys_addr);
+    if (status)
+    {
+        dev_err(dev, "dma_map_single error @ va:%p pa:%llX for %s\n", buf_info->vaddr, virt_to_phys(buf_info->vaddr), buf_name);
+        kfree(buf_info->vaddr);
+        return status;
+    }
+    buf_info->host_phys_addr = virt_to_phys(buf_info->vaddr);
+    dev_info(dev,
+        "%s size: %i, va:0x%px pa:0x%llx bus:0x%llx\n",
+        buf_name,
+        buf_size,
+        buf_info->vaddr,
+        virt_to_phys(buf_info->vaddr),
+        buf_info->phys_addr);
+    return 0;
+}
+
+static int la9310_free_dma_buf(
+    struct device* dev, const char* buf_name, struct la9310_mem_region_info* buf_info, enum dma_data_direction dma_dir)
+{
+    dev_info(dev,
+        "Unmap and free %s size: %lu, va:0x%px pa:0x%llx bus:0x%llx\n",
+        buf_name,
+        buf_info->size,
+        buf_info->vaddr,
+        virt_to_phys(buf_info->vaddr),
+        buf_info->phys_addr);
+    if (buf_info->phys_addr)
+        dma_unmap_single(dev, buf_info->phys_addr, buf_info->size, dma_dir);
+    if (buf_info->vaddr)
+        kfree(buf_info->vaddr);
+
+    dev_info(dev, "Unmapped and freed %s\n", buf_name);
+
+    return 0;
+}
+
 static int
 la9310_scratch_dma_buf(struct la9310_dev *la9310_dev)
 {
@@ -404,17 +460,29 @@ la9310_scratch_dma_buf(struct la9310_dev *la9310_dev)
 	int rc = 0;
 
 	host_region = &dma_info->host_buf;
-	scratch_buf_size = ALIGN(scratch_buf_size, PAGE_SIZE);
-	host_region->vaddr = ioremap(scratch_buf_phys_addr, scratch_buf_size);
+	scratch_buf_size = LA9310_DMA_BUF_SIZE;
+
+        rc = la9310_alloc_dma_buf(la9310_dev->dev, "Scratch buffer", host_region, scratch_buf_size, DMA_BIDIRECTIONAL);
+        if (rc)
+                return rc;
+
+        scratch_buf_phys_addr=host_region->phys_addr;
+        scratch_buf_host_phys_addr=host_region->host_phys_addr;
+
 	dev_info(la9310_dev->dev, "Virtual address after ioremap=%px\n",
 		 host_region->vaddr);
-	if ((!host_region->vaddr) || (scratch_buf_size < LA9310_DMA_BUF_SIZE)) {
-		dev_err(la9310_dev->dev, "ERR: ioremap DDR Address Failed\n");
-		iounmap(host_region->vaddr);
-		return -ENOMEM;
-	}
-	host_region->phys_addr = scratch_buf_phys_addr;
-	host_region->size = scratch_buf_size;
+
+        if ((!host_region->vaddr) || (scratch_buf_size < LA9310_DMA_BUF_SIZE))
+        {
+                dev_err(la9310_dev->dev, "ERR: ioremap DDR Address Failed\n");
+                if (scratch_buf_size < LA9310_DMA_BUF_SIZE)
+                        dev_err(la9310_dev->dev,
+                        "Scratch buffer to small (%i), expected >= %i\n",
+                        scratch_buf_size,
+                        LA9310_DMA_BUF_SIZE);
+                return -ENOMEM;
+        }
+
 	memset_io(host_region->vaddr, 0, scratch_buf_size);
 	dma_info->dma_region_used = 0;
 
@@ -430,7 +498,8 @@ la9310_scratch_dma_buf(struct la9310_dev *la9310_dev)
 	return 0;
 out:
 	iounmap(host_region->vaddr);
-
+        la9310_free_dma_buf(la9310_dev->dev, "Scratch buffer", host_region, DMA_BIDIRECTIONAL);
+ 
 	return rc;
 }
 
@@ -686,6 +755,34 @@ la9310_init_msg_unit_ptrs(struct la9310_dev *la9310_dev)
 
 }
 
+static int
+la9310_base_cleanup_subdrv(struct la9310_dev *la9310_dev, int drv_index)
+{
+        int i = 0, rc = 0;
+        struct la9310_sub_driver *subdrv;
+        struct la9310_sub_driver_ops *ops;
+
+        dev_info(la9310_dev->dev,
+                 "%s: Removing sub-drivers because of error\n",
+                 la9310_dev->name);
+        for (i = drv_index; i >= 0; i--) {
+                subdrv = la9310_get_subdrv(i);
+                ops = &subdrv->ops;
+                if (ops->remove) {
+                        pr_debug("%s: subdrv remove : %s\n",
+                                 __func__, &subdrv->name[0]);
+
+                        rc = ops->remove(la9310_dev);
+                        if (rc) {
+                                pr_err("%s: %s: Remove failed, err %d\n",
+                                       __func__, &subdrv->name[0], rc);
+                                /*Other drivers to be removed so continue */
+                        }
+                }
+        }
+        return rc;
+}
+
 int
 la9310_base_probe(struct la9310_dev *la9310_dev)
 {
@@ -696,9 +793,8 @@ la9310_base_probe(struct la9310_dev *la9310_dev)
 	struct virq_evt_map *subdrv_virqmap_ptr;
 	u32    pci_abserr;
 	struct la9310_mem_region_info *ccsr_region;
-	struct device_node *np;
-	struct resource mem_addr;
 	u64 start_time, end_time, diff;
+        struct la9310_mem_region_info iqflood_region;
 
 	start_time = get_jiffies_64();
 
@@ -708,24 +804,22 @@ la9310_base_probe(struct la9310_dev *la9310_dev)
 	rc = la9310_scratch_dma_buf(la9310_dev);
 	if (rc) {
 		dev_err(la9310_dev->dev,
-				"Failed to init DMA buf for outbound, err %d\n", rc);
+				"Failed to init SCRATCH DMA buf for outbound, err %d\n", rc);
 		goto out;
 	}
 
-	if (iq_mem_addr ==0) {
-		np = of_find_node_by_name(NULL, "iqflood");
-		if (!np)
-			np = of_find_node_by_name(NULL, "iq");
+        init_stage = LA9310_IQFLOOD_DMA_INIT_STAGE;
+        iq_mem_size = 32 * 1024 * 1024;
+        rc = la9310_alloc_dma_buf(
+            la9310_dev->dev, "IQ Flood Buffer", &iqflood_region, iq_mem_size, DMA_BIDIRECTIONAL);
+        if (rc) {
+                dev_err(la9310_dev->dev,
+                                "Failed to init IQFLOOD DMA buf for outbound, err %d\n", rc);
+                goto out;
+        }
 
-		if (np) {
-			rc = of_address_to_resource(np, 0, &mem_addr);
-			if (!rc) {
-				iq_mem_addr = mem_addr.start;
-				iq_mem_size = resource_size(&mem_addr);
-			}
-			of_node_put(np);
-		}
-	}
+        iq_mem_addr = iqflood_region.phys_addr;
+        iq_mem_host_addr = iqflood_region.host_phys_addr;
 
 	la9310_create_rfnm_iqflood_outbound(la9310_dev);
 
@@ -847,82 +941,49 @@ la9310_base_probe(struct la9310_dev *la9310_dev)
 	dev_info(la9310_dev->dev, "Probed OK, %s  Time elasped %llu msec \n",
                         __func__, (diff * 1000 / HZ));
 
-
-out:
-	if (rc)
-		la9310_base_deinit(la9310_dev, init_stage, i);
-
 	return rc;
 
-}
-
-static int
-la9310_base_cleanup_subdrv(struct la9310_dev *la9310_dev, int drv_index)
-{
-	int i = 0, rc = 0;
-	struct la9310_sub_driver *subdrv;
-	struct la9310_sub_driver_ops *ops;
-
-	dev_info(la9310_dev->dev,
-		 "%s: Removing sub-drivers because of error\n",
-		 la9310_dev->name);
-	for (i = drv_index; i >= 0; i--) {
-		subdrv = la9310_get_subdrv(i);
-		ops = &subdrv->ops;
-		if (ops->remove) {
-			pr_debug("%s: subdrv remove : %s\n",
-				 __func__, &subdrv->name[0]);
+out:
+    la9310_modinfo_exit(la9310_dev);
+
+    switch (init_stage) {
+        case LA9310_SUBDRV_PROBE_STAGE:
+                la9310_base_cleanup_subdrv(la9310_dev, i);
+#ifdef  LA9310_RESET_HANDSHAKE_POLLING_ENABLE
+                free_irq(la9310_get_msi_irq(la9310_dev, MSI_IRQ_MUX),
+                         la9310_dev);
+#endif
+                __attribute__((__fallthrough__));
+                /*Fallthrough */
+        case LA9310_IRQ_INIT_STAGE:
+                la9310_clean_request_irq(la9310_dev,
+                                         &la9310_dev->hif->irq_evt_regs);
+                __attribute__((__fallthrough__));
+                /*Fallthrough */
+        case LA9310_HANDSHAKE_INIT_STAGE:
+#ifndef LA9310_RESET_HANDSHAKE_POLLING_ENABLE
+                free_irq(la9310_get_msi_irq
+                         (la9310_dev, MSI_IRQ_HOST_HANDSHAKE), la9310_dev);
+                free_irq(la9310_get_msi_irq(la9310_dev, MSI_IRQ_MUX),
+                         la9310_dev);
+#endif
+                __attribute__((__fallthrough__));
+                /*Fallthrough */
+        case LA9310_SYSFS_INIT_STAGE:
+                la9310_remove_sysfs(la9310_dev);
+                __attribute__((__fallthrough__));
+                /*Fallthrough */
+        case LA9310_IQFLOOD_DMA_INIT_STAGE:
+                la9310_free_dma_buf(
+                    la9310_dev->dev, "IQ Flood Buffer", &iqflood_region, DMA_BIDIRECTIONAL);
+                __attribute__((__fallthrough__));
+                /*Fallthrough */
+        case LA9310_SCRATCH_DMA_INIT_STAGE:
+                iounmap(&la9310_dev->dma_info.host_buf.vaddr);
+        }
 
-			rc = ops->remove(la9310_dev);
-			if (rc) {
-				pr_err("%s: %s: Remove failed, err %d\n",
-				       __func__, &subdrv->name[0], rc);
-				/*Other drivers to be removed so continue */
-			}
-		}
-	}
 	return rc;
-}
 
-int
-la9310_base_deinit(struct la9310_dev *la9310_dev, int stage, int drv_index)
-{
-	struct la9310_dma_info *dma_info = &la9310_dev->dma_info;
-	struct la9310_mem_region_info *host_region;
-
-	la9310_modinfo_exit(la9310_dev);
-	switch (stage) {
-	case LA9310_SUBDRV_PROBE_STAGE:
-		la9310_base_cleanup_subdrv(la9310_dev, drv_index);
-#ifdef	LA9310_RESET_HANDSHAKE_POLLING_ENABLE
-		free_irq(la9310_get_msi_irq(la9310_dev, MSI_IRQ_MUX),
-			 la9310_dev);
-#endif
-		__attribute__((__fallthrough__));
-		/*Fallthrough */
-	case LA9310_IRQ_INIT_STAGE:
-		la9310_clean_request_irq(la9310_dev,
-					 &la9310_dev->hif->irq_evt_regs);
-		__attribute__((__fallthrough__));
-		/*Fallthrough */
-	case LA9310_HANDSHAKE_INIT_STAGE:
-#ifndef	LA9310_RESET_HANDSHAKE_POLLING_ENABLE
-		free_irq(la9310_get_msi_irq
-			 (la9310_dev, MSI_IRQ_HOST_HANDSHAKE), la9310_dev);
-		free_irq(la9310_get_msi_irq(la9310_dev, MSI_IRQ_MUX),
-			 la9310_dev);
-#endif
-		__attribute__((__fallthrough__));
-		/*Fallthrough */
-	case LA9310_SYSFS_INIT_STAGE:
-		la9310_remove_sysfs(la9310_dev);
-		__attribute__((__fallthrough__));
-		/*Fallthrough */
-	case LA9310_SCRATCH_DMA_INIT_STAGE:
-		host_region = &dma_info->host_buf;
-		iounmap(host_region->vaddr);
-	}
-	return 0;
 }
 
 int
diff --git a/kernel_driver/la9310shiva/la9310_base.h b/kernel_driver/la9310shiva/la9310_base.h
index d7aafbb..21e5f0b 100644
--- a/kernel_driver/la9310shiva/la9310_base.h
+++ b/kernel_driver/la9310shiva/la9310_base.h
@@ -50,8 +50,10 @@ extern int adc_rate_mask;
 extern int dac_rate_mask;
 extern int iq_mem_size;
 extern uint64_t iq_mem_addr;
+extern uint64_t iq_mem_host_addr;
 extern int modem_rf_data_size;
 extern uint64_t scratch_buf_phys_addr;
+extern uint64_t scratch_buf_host_phys_addr;
 extern char firmware_name[];
 extern char vspa_fw_name[];
 extern char la9310_dev_name[];
@@ -63,6 +65,7 @@ extern struct la9310_global g_la9310_global[];
 
 enum la9310_init_stage {
 	LA9310_SCRATCH_DMA_INIT_STAGE = 1,
+        LA9310_IQFLOOD_DMA_INIT_STAGE,
 	LA9310_SYSFS_INIT_STAGE,
 	LA9310_HANDSHAKE_INIT_STAGE,
 	LA9310_IRQ_INIT_STAGE,
@@ -165,6 +168,7 @@ typedef enum la9310_stat_control {
 
 struct la9310_mem_region_info {
 	phys_addr_t phys_addr;
+        phys_addr_t host_phys_addr;
 	u8 __iomem *vaddr;
 	size_t size;
 };
@@ -239,7 +243,7 @@ struct la9310_dma_info {
 					LA9310_FREERTOS_INTERRUPT_STACK))
 #define LA9310_DBUG_LOG_SIZE		(4 * 1024)
 #define LA9310_IQ_SAMPLES_SIZE		(20 * 1024 * 1024)
-#define LA9310_NLM_OPS_SIZE		(16 * 1024 * 1024)
+#define LA9310_NLM_OPS_SIZE		(8 * 1024 * 1024)
 #define LA9310_STD_FW_SIZE		(128 * 1024)
 #define LA9310_SHARE_RF_SIZE		(200 * 1024) /* 200KB */
 /* Mem region separator */
diff --git a/kernel_driver/la9310shiva/la9310_modinfo.c b/kernel_driver/la9310shiva/la9310_modinfo.c
index b2a53b5..711b02f 100644
--- a/kernel_driver/la9310shiva/la9310_modinfo.c
+++ b/kernel_driver/la9310shiva/la9310_modinfo.c
@@ -190,7 +190,7 @@ void la9310_modinfo_get(struct la9310_dev *la9310_dev, modinfo_t *mi)
 	mi->hif.host_phy_addr = la9310_dev->mem_regions[LA9310_MEM_REGION_TCML].phys_addr + LA9310_EP_HIF_OFFSET;
 	mi->hif.size = sizeof(struct la9310_hif);
 
-	mi->scratchbuf.host_phy_addr = scratch_buf_phys_addr;
+	mi->scratchbuf.host_phy_addr = scratch_buf_host_phys_addr;
 	mi->scratchbuf.size = scratch_buf_size;
 
 	mi->dac_mask = dac_mask;
@@ -199,7 +199,7 @@ void la9310_modinfo_get(struct la9310_dev *la9310_dev, modinfo_t *mi)
 	mi->dac_rate_mask = dac_rate_mask;
 
 	mi->iqflood.modem_phy_addr = LA9310_IQFLOOD_PHYS_ADDR;
-	mi->iqflood.host_phy_addr = iq_mem_addr;
+	mi->iqflood.host_phy_addr = iq_mem_host_addr;
 	mi->iqflood.size = iq_mem_size;
 }
 
diff --git a/kernel_driver/la9310shiva/la9310_pci.c b/kernel_driver/la9310shiva/la9310_pci.c
index 033c321..440e3ca 100644
--- a/kernel_driver/la9310shiva/la9310_pci.c
+++ b/kernel_driver/la9310shiva/la9310_pci.c
@@ -31,6 +31,7 @@
 static const char *driver_name = "la9310-shiva";
 int scratch_buf_size;
 uint64_t scratch_buf_phys_addr;
+uint64_t scratch_buf_host_phys_addr;
 
 int dac_mask = 0x1;
 EXPORT_SYMBOL(dac_mask);
@@ -48,7 +49,9 @@ EXPORT_SYMBOL(dac_rate_mask);
 int modem_rf_data_size = LA9310_SHARE_RF_SIZE;
 EXPORT_SYMBOL(modem_rf_data_size);
 uint64_t iq_mem_addr;
+uint64_t iq_mem_host_addr;
 EXPORT_SYMBOL_GPL(iq_mem_addr);
+EXPORT_SYMBOL_GPL(iq_mem_host_addr);
 int iq_mem_size;
 EXPORT_SYMBOL_GPL(iq_mem_size);
 char firmware_name[FIRMWARE_NAME_SIZE] = FIRMWARE_RTOS;
@@ -606,21 +609,6 @@ static int __init la9310_pcidev_init(void)
 	start_time = get_jiffies_64();
 	pr_info("NXP PCIe LA9310 Driver: Init.\n");
 
-	if (!(scratch_buf_size && scratch_buf_phys_addr)) {
-		pr_err("ERR %s: Scratch buf values should be non zero\n",
-		       __func__);
-		err = -EINVAL;
-		goto out;
-	}
-
-	if ((scratch_buf_size <= LA9310_VSPA_FW_SIZE) ||
-	    (scratch_buf_size > LA9310_MAX_SCRATCH_BUF_SIZE)) {
-		pr_err("ERR %s: Scratch_buf_size is not correct 0x%x (Range - 0x%x-0x%x)\n", __func__,
-			scratch_buf_size, LA9310_VSPA_FW_SIZE, LA9310_MAX_SCRATCH_BUF_SIZE);
-		err = -EINVAL;
-		goto out;
-	}
-
 	if (!(strlen(vspa_fw_name))) {
 		pr_err("ERR %s: alt_vspa_fw_name empty", __func__);
 		err = -EINVAL;
@@ -693,10 +681,7 @@ static void __exit la9310_pcidev_exit(void)
 
 module_init(la9310_pcidev_init);
 module_exit(la9310_pcidev_exit);
-module_param(scratch_buf_size, int, 0);
-MODULE_PARM_DESC(scratch_buf_size, "Scratch buffer size for LA9310 Device");
-module_param(scratch_buf_phys_addr, ullong, 0);
-MODULE_PARM_DESC(scratch_buf_phys_addr, "Scratch buffer start physical address");
+
 module_param(adc_mask, int, 0400);
 MODULE_PARM_DESC(adc_mask, "ADC channel enable mask - bit wise (MAX 0x4)");
 module_param(adc_rate_mask, int, 0400);
@@ -707,10 +692,6 @@ MODULE_PARM_DESC(dac_mask, "DAC channel enable mask - bit wise (MAX 0x2)");
 module_param(dac_rate_mask, int, 0400);
 MODULE_PARM_DESC(dac_rate_mask,
 	"DAC Frequency for each channel (0 for Full Duplex, 1 for Half Duplex");
-module_param(iq_mem_addr, ullong, 0400);
-MODULE_PARM_DESC(iq_mem_addr, "SDR IQ Flood Mem Address");
-module_param(iq_mem_size, int, 0400);
-MODULE_PARM_DESC(iq_mem_addr, "SDR IQ Flood Mem Size");
 module_param(modem_rf_data_size, int, 0400);
 MODULE_PARM_DESC(modem_rf_data_size, "RFIC buffer size for each LA931x devices");
 module_param_string(alt_vspa_fw_name, vspa_fw_name,
-- 
2.34.1

